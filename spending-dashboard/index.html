<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARC Spending & Strategy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .counties-list {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small {
            height: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .narrative-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .narrative-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .narrative-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .progress-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .progress-strategy {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .progress-detail {
            color: #666;
            font-size: 0.95rem;
        }

        .county-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .county-breakdown-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 5px solid;
        }

        .county-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .county-breakdown-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .county-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .county-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .county-stat-number {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .county-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .strategy-list {
            margin-top: 15px;
        }

        .strategy-list-item {
            padding: 10px;
            background: #f8f9fa;
            margin: 6px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strategy-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .strategy-amount {
            font-weight: bold;
            color: #667eea;
        }

        .narrative-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .narrative-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .narrative-tab:hover {
            background: #e8e9ea;
        }

        .narrative-tab.active {
            color: white;
            border-color: transparent;
        }

        .narrative-content {
            display: none;
        }

        .narrative-content.active {
            display: block;
        }

        /* Main Tab Navigation */
        .main-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .main-tab {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            color: #2c3e50;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-tab:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Overview Tab Styles */
        .overview-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        .metric-sublabel {
            font-size: 0.85rem;
            color: #999;
            margin-top: 5px;
        }

        /* Success Stories Gallery */
        .success-stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .success-story-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .success-story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .success-story-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .success-story-id {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .success-story-county {
            padding: 5px 12px;
            border-radius: 15px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .success-story-summary {
            color: #555;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-tabs {
                flex-direction: column;
            }

            .main-tab {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Southeastern NC Opioid Response Dashboard</h1>
            <p>Investment & Impact Analysis</p>
        </div>

        <div class="counties-list">
            Robeson • Cumberland • Scotland • Richmond • Bladen • Columbus
        </div>

        <div id="loading" class="loading">
            Loading data from Excel file...
        </div>

        <div id="error" style="display: none;" class="error"></div>

        <div id="dashboard" style="display: none;">
            <!-- Main Tab Navigation -->
            <div class="main-tabs">
                <button class="main-tab active" data-tab="overview">
                    <span>📊</span> Overview
                </button>
                <button class="main-tab" data-tab="spending">
                    <span>💰</span> Spending Analysis
                </button>
                <button class="main-tab" data-tab="outcomes">
                    <span>📈</span> Outcomes & Impact
                </button>
                <button class="main-tab" data-tab="stories">
                    <span>🏆</span> Success Stories
                </button>
                <button class="main-tab" data-tab="counties">
                    <span>📍</span> County Profiles
                </button>
            </div>

            <!-- Tab 1: Overview -->
            <div id="tab-overview" class="main-tab-content active">
                <div class="overview-metrics" id="overviewMetricsContainer"></div>
                <div class="chart-card">
                    <h2 class="chart-title">Regional Impact Summary</h2>
                    <div id="overviewSummaryContainer"></div>
                </div>
            </div>

            <!-- Tab 2: Spending Analysis -->
            <div id="tab-spending" class="main-tab-content">
                <div class="dashboard-grid">
                <div class="chart-card">
                    <h2 class="chart-title">Total Spending by County</h2>
                    <div class="chart-container">
                        <canvas id="spendingByCountyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 class="chart-title">Spending by Strategy Category</h2>
                    <div class="chart-container">
                        <canvas id="strategyCategoryChart"></canvas>
                    </div>
                </div>

                <!-- Strategies Funded by County - Commented out for now, can be restored later
                <div class="chart-card full-width">
                    <h2 class="chart-title">Strategies Funded by County</h2>
                    <div id="strategiesTabsContainer"></div>
                    <div id="strategiesChartsContainer" style="position: relative; height: 400px;"></div>
                </div>
                -->

                <div class="chart-card full-width">
                    <h2 class="chart-title">Detailed Spending Breakdown</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="detailTable">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th>Strategy</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Fiscal Year</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Tab 3: Outcomes & Impact -->
            <div id="tab-outcomes" class="main-tab-content">
                <div class="chart-card full-width">
                    <h2 class="chart-title">People Served & Naloxone Distribution</h2>
                    <div id="outcomesChartsContainer" class="dashboard-grid"></div>
                </div>
                <div class="chart-card full-width">
                    <h2 class="chart-title">Treatment Outcomes by County</h2>
                    <div id="treatmentOutcomesContainer"></div>
                </div>
            </div>

            <!-- Tab 4: Success Stories -->
            <div id="tab-stories" class="main-tab-content">
                <div class="chart-card full-width">
                    <h2 class="chart-title">Success Stories Gallery</h2>
                    <div class="success-stories-grid" id="successStoriesContainer"></div>
                </div>
            </div>

            <!-- Tab 5: County Profiles -->
            <div id="tab-counties" class="main-tab-content">
                <div class="chart-card full-width">
                    <h2 class="chart-title">County Deep Dive Profiles</h2>
                    <div class="county-breakdown-grid" id="countyBreakdownsContainer"></div>
                </div>
                <div class="chart-card full-width">
                    <h2 class="chart-title">County Narratives & Strategy Progress</h2>
                    <div id="narrativesContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Focus counties
        const FOCUS_COUNTIES = ['Robeson', 'Cumberland', 'Scotland', 'Richmond', 'Bladen', 'Columbus'];

        // County color scheme (consistent with enhanced dashboard)
        const COUNTY_COLORS = {
            'Cumberland': '#e74c3c',
            'Robeson': '#3498db',
            'Richmond': '#e67e22',
            'Columbus': '#f39c12',
            'Bladen': '#9b59b6',
            'Scotland': '#27ae60'
        };

        // Load and process Excel file
        async function loadData() {
            try {
                // Load Excel data
                const response = await fetch('CORE-NC Opioid Settlement Public Data Tables.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Read relevant sheets
                const govtsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['govts']);
                const strategiesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['strategies']);
                const categoriesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['categories']);
                const finDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['fin_detail']);
                const paymentsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['payments_detail']);
                const impactSummarySheet = XLSX.utils.sheet_to_json(workbook.Sheets['impact_summary']);
                const impactDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['impact_detail']);

                // Load narrative data from JSON
                let narrativeData = null;
                try {
                    const narrativeResponse = await fetch('county-narrative-data.json');
                    narrativeData = await narrativeResponse.json();
                    console.log('✅ Narrative data loaded successfully:', narrativeData);
                } catch (narrativeError) {
                    console.warn('❌ Could not load narrative data:', narrativeError);
                }

                // Process data
                processData(govtsSheet, strategiesSheet, categoriesSheet, finDetailSheet, paymentsSheet, impactSummarySheet, impactDetailSheet, narrativeData);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'Error loading data: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function processData(govts, strategies, categories, finDetail, payments, impactSummary, impactDetail, narrativeData) {
            // Filter data for focus counties
            const focusCountyData = finDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create lookups
            const strategyLookup = {};
            strategies.forEach(strat => {
                strategyLookup[strat.strat_id_num] = strat;
            });

            const categoryLookup = {};
            categories.forEach(cat => {
                // Try multiple possible field names for category name
                const catName = cat.strat_cat_name || cat.strat_category_name || cat.category_name || cat.name;
                categoryLookup[cat.strat_cat_letter] = catName || cat.strat_cat_letter;
            });

            // Add fallback descriptions if not in data
            if (!categoryLookup['L'] || categoryLookup['L'] === 'L') {
                categoryLookup['L'] = 'Core Strategies';
            }
            if (!categoryLookup['C'] || categoryLookup['C'] === 'C') {
                categoryLookup['C'] = 'Collaborative Strategic Planning';
            }
            if (!categoryLookup['H'] || categoryLookup['H'] === 'H') {
                categoryLookup['H'] = 'Other Abatement Strategies';
            }

            // Aggregate spending by county
            const spendingByCounty = {};
            const spendingByCategory = {};
            const strategiesByCounty = {};

            focusCountyData.forEach(row => {
                const county = extractCountyName(row.govt_name);
                const amount = parseFloat(row.fd_strat_funds_applied) || 0;
                const stratId = row.strat_id_num;
                const strategy = strategyLookup[stratId];

                if (county && amount > 0) {
                    // Spending by county
                    spendingByCounty[county] = (spendingByCounty[county] || 0) + amount;

                    // Spending by category
                    if (strategy && strategy.strat_cat_letter) {
                        const category = strategy.strat_cat_letter;
                        spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
                    }

                    // Strategies by county
                    if (!strategiesByCounty[county]) {
                        strategiesByCounty[county] = {};
                    }
                    if (strategy && strategy.strat_exhibit_letter) {
                        const stratName = `${strategy.strat_exhibit_letter}`;
                        strategiesByCounty[county][stratName] = (strategiesByCounty[county][stratName] || 0) + amount;
                    }
                }
            });

            // Filter impact data for focus counties
            const focusImpactSummary = impactSummary.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            const focusImpactDetail = impactDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create visualizations for all tabs
            createOverviewTab(spendingByCounty, narrativeData);
            createSpendingByCountyChart(spendingByCounty);
            createStrategyCategoryChart(spendingByCategory, categoryLookup);
            createDetailTable(focusCountyData, strategyLookup, categoryLookup);
            createOutcomesTab(narrativeData);
            createSuccessStoriesGallery(narrativeData);
            createCountyBreakdowns(spendingByCounty, strategiesByCounty, strategyLookup, categoryLookup, focusCountyData, narrativeData);
            createNarrativesSection(focusImpactSummary, focusImpactDetail, strategyLookup);

            // Setup tab navigation
            setupTabNavigation();

            // Hide loading, show dashboard
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.main-tab');
            const tabContents = document.querySelectorAll('.main-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;

                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(`tab-${targetTab}`).classList.add('active');
                });
            });
        }

        function createOverviewTab(spendingByCounty, narrativeData) {
            // Calculate regional totals
            const totalSpending = Object.values(spendingByCounty).reduce((sum, val) => sum + val, 0);
            const totalPeopleServed = narrativeData?.regional_totals?.people_served || 0;
            const totalNaloxoneKits = narrativeData?.regional_totals?.naloxone_kits || 0;
            const totalTreatmentDays = narrativeData?.regional_totals?.treatment_days || 0;
            const countiesServing = Object.keys(spendingByCounty).length;

            // Create metric cards
            const container = document.getElementById('overviewMetricsContainer');
            const metrics = [
                { number: `$${(totalSpending / 1000000).toFixed(2)}M`, label: 'Total Investment', sublabel: 'Opioid Settlement Funds' },
                { number: totalPeopleServed.toLocaleString() + '+', label: 'People Served', sublabel: 'Across all counties' },
                { number: totalNaloxoneKits.toLocaleString() + '+', label: 'Naloxone Kits', sublabel: 'Distributed to community' },
                { number: totalTreatmentDays.toLocaleString() + '+', label: 'Treatment Days', sublabel: 'Provided to residents' },
                { number: countiesServing, label: 'Counties Active', sublabel: 'Implementing programs' }
            ];

            container.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-number">${metric.number}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-sublabel">${metric.sublabel}</div>
                </div>
            `).join('');

            // Create summary table
            const summaryContainer = document.getElementById('overviewSummaryContainer');
            const sortedCounties = Object.entries(spendingByCounty).sort((a, b) => b[1] - a[1]);

            let tableHtml = '<table class="data-table"><thead><tr><th>Rank</th><th>County</th><th>Investment</th><th>People Served</th><th>Naloxone Kits</th><th>Cost/Person</th></tr></thead><tbody>';

            sortedCounties.forEach(([county, spending], index) => {
                const countyData = narrativeData?.counties?.[county];
                const peopleServed = countyData?.people_served || 'N/A';
                const naloxoneKits = countyData?.naloxone_kits || 'N/A';
                const costPerPerson = peopleServed && peopleServed !== 'N/A' ?
                    `$${Math.round(spending / peopleServed).toLocaleString()}` : 'N/A';

                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-weight: 600; color: ${COUNTY_COLORS[county]}">${county}</td>
                        <td>$${spending.toLocaleString()}</td>
                        <td>${typeof peopleServed === 'number' ? peopleServed.toLocaleString() : peopleServed}</td>
                        <td>${typeof naloxoneKits === 'number' ? naloxoneKits.toLocaleString() : naloxoneKits}</td>
                        <td>${costPerPerson}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            // Add explanation note
            tableHtml += `
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 5px;">
                    <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.1rem;">Understanding Strategy Options</h3>
                    <p style="color: #555; line-height: 1.6; margin-bottom: 10px;">
                        <strong>All counties start with Option A</strong> (12 high-impact strategies including naloxone distribution, recovery support, and MAT services).
                    </p>
                    <p style="color: #555; line-height: 1.6; margin-bottom: 10px;">
                        Counties can <strong>unlock Option B</strong> (80+ additional strategies) by completing a comprehensive strategic planning process.
                        Option B adds prevention programs, data systems, training, and specialized services.
                    </p>
                    <p style="color: #555; line-height: 1.6;">
                        <strong>Current Status:</strong> Columbus ✨ has unlocked Option B. Robeson and Bladen 🔄 are in strategic planning to expand.
                        Cumberland, Richmond, and Scotland are effectively using Option A strategies with strong results.
                    </p>
                </div>
            `;

            summaryContainer.innerHTML = tableHtml;
        }

        function createSuccessStoriesGallery(narrativeData) {
            const container = document.getElementById('successStoriesContainer');
            if (!narrativeData?.counties) return;

            let storiesHtml = '';
            Object.entries(narrativeData.counties).forEach(([county, data]) => {
                if (data.success_stories && data.success_stories.length > 0) {
                    data.success_stories.forEach(story => {
                        storiesHtml += `
                            <div class="success-story-card" style="border-left-color: ${COUNTY_COLORS[county]}">
                                <div class="success-story-header">
                                    <div class="success-story-id">${story.id}</div>
                                    <div class="success-story-county" style="background: ${COUNTY_COLORS[county]}">${county}</div>
                                </div>
                                <div class="success-story-summary">${story.summary}</div>
                            </div>
                        `;
                    });
                }
            });

            container.innerHTML = storiesHtml || '<p style="text-align: center; color: #666;">No success stories available.</p>';
        }

        function createOutcomesTab(narrativeData) {
            if (!narrativeData?.counties) return;

            // Create charts for people served and naloxone distribution
            const chartsContainer = document.getElementById('outcomesChartsContainer');
            chartsContainer.innerHTML = `
                <div class="chart-card">
                    <h2 class="chart-title">People Served by County</h2>
                    <div class="chart-container">
                        <canvas id="peopleServedChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h2 class="chart-title">Naloxone Kits Distributed</h2>
                    <div class="chart-container">
                        <canvas id="naloxoneChart"></canvas>
                    </div>
                </div>
            `;

            // People served chart
            const peopleServedData = {};
            const naloxoneData = {};

            Object.entries(narrativeData.counties).forEach(([county, data]) => {
                if (data.people_served) peopleServedData[county] = data.people_served;
                if (data.naloxone_kits) naloxoneData[county] = data.naloxone_kits;
            });

            // Create people served chart
            if (Object.keys(peopleServedData).length > 0) {
                const ctx = document.getElementById('peopleServedChart').getContext('2d');
                const counties = Object.keys(peopleServedData);
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: counties,
                        datasets: [{
                            label: 'People Served',
                            data: counties.map(c => peopleServedData[c]),
                            backgroundColor: counties.map(c => COUNTY_COLORS[c] + '80'),
                            borderColor: counties.map(c => COUNTY_COLORS[c]),
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold', size: 12 },
                                color: (context) => COUNTY_COLORS[counties[context.dataIndex]]
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Create naloxone chart
            if (Object.keys(naloxoneData).length > 0) {
                const ctx = document.getElementById('naloxoneChart').getContext('2d');
                const counties = Object.keys(naloxoneData);
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: counties,
                        datasets: [{
                            label: 'Naloxone Kits',
                            data: counties.map(c => naloxoneData[c]),
                            backgroundColor: counties.map(c => COUNTY_COLORS[c] + '80'),
                            borderColor: counties.map(c => COUNTY_COLORS[c]),
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value.toLocaleString(),
                                font: { weight: 'bold', size: 12 },
                                color: (context) => COUNTY_COLORS[counties[context.dataIndex]]
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Treatment outcomes - detailed county cards
            const outcomesContainer = document.getElementById('treatmentOutcomesContainer');
            let outcomesHtml = '<div class="county-breakdown-grid" style="margin-top: 0;">';

            Object.entries(narrativeData.counties).forEach(([county, data]) => {
                outcomesHtml += `
                    <div class="county-breakdown-card" style="border-top-color: ${COUNTY_COLORS[county]}">
                        <div class="county-breakdown-header">
                            <div class="county-breakdown-name" style="color: ${COUNTY_COLORS[county]}">${county} County</div>
                        </div>
                `;

                // Build outcome sections based on what data is available
                let sections = [];

                // Cumberland - detailed outcomes
                if (county === 'Cumberland' && data.outcomes) {
                    sections.push(`
                        <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Service Connections</h4>
                        <div class="county-stat-grid" style="grid-template-columns: repeat(2, 1fr);">
                            ${data.outcomes.treatment_referrals ? `<div class="county-stat">
                                <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.outcomes.treatment_referrals}</div>
                                <div class="county-stat-label">Treatment Referrals</div>
                            </div>` : ''}
                            ${data.outcomes.recovery_connections ? `<div class="county-stat">
                                <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.outcomes.recovery_connections}</div>
                                <div class="county-stat-label">Recovery Connections</div>
                            </div>` : ''}
                            ${data.outcomes.harm_reduction_referrals ? `<div class="county-stat">
                                <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.outcomes.harm_reduction_referrals}</div>
                                <div class="county-stat-label">Harm Reduction</div>
                            </div>` : ''}
                            ${data.outcomes.primary_healthcare ? `<div class="county-stat">
                                <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.outcomes.primary_healthcare}</div>
                                <div class="county-stat-label">Primary Healthcare</div>
                            </div>` : ''}
                            ${data.outcomes.other_service_referrals ? `<div class="county-stat">
                                <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.outcomes.other_service_referrals}</div>
                                <div class="county-stat-label">Other Services</div>
                            </div>` : ''}
                            ${data.outcomes.total_contacts ? `<div class="county-stat">
                                <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.outcomes.total_contacts.toLocaleString()}</div>
                                <div class="county-stat-label">Total Contacts</div>
                            </div>` : ''}
                        </div>
                    `);

                    if (data.programs) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Program Outcomes</h4>
                            <div class="strategy-list">
                                ${data.programs.diversion ? `<div class="strategy-list-item">
                                    <span class="strategy-name">LEAD Diversion</span>
                                    <span class="strategy-amount">${data.programs.diversion.enrolled} enrolled, ${data.programs.diversion.placements} placements</span>
                                </div>` : ''}
                                ${data.programs.detention_mat ? `<div class="strategy-list-item">
                                    <span class="strategy-name">Detention Center MAT</span>
                                    <span class="strategy-amount">${data.programs.detention_mat.served} served</span>
                                </div>` : ''}
                                ${data.programs.reentry ? `<div class="strategy-list-item">
                                    <span class="strategy-name">Reentry Program</span>
                                    <span class="strategy-amount">${data.programs.reentry.enrolled} enrolled, ${data.programs.reentry.case_management_meetings.toLocaleString()} meetings</span>
                                </div>` : ''}
                                ${data.programs.employment ? `<div class="strategy-list-item">
                                    <span class="strategy-name">Employment Support</span>
                                    <span class="strategy-amount">${data.programs.employment.served} served, ${data.programs.employment.workshops} workshops</span>
                                </div>` : ''}
                                ${data.programs.recovery_housing ? `<div class="strategy-list-item">
                                    <span class="strategy-name">Recovery Housing</span>
                                    <span class="strategy-amount">${data.programs.recovery_housing.served} served, ${data.programs.recovery_housing.rent_assistance} rent assistance</span>
                                </div>` : ''}
                            </div>
                        `);
                    }
                }

                // Robeson - treatment and overdose reduction
                if (county === 'Robeson') {
                    if (data.treatment) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Treatment Services</h4>
                            <div class="county-stat-grid">
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.treatment.inpatient}</div>
                                    <div class="county-stat-label">Inpatient</div>
                                </div>
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.treatment.outpatient}</div>
                                    <div class="county-stat-label">Outpatient</div>
                                </div>
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.treatment.mat_services}</div>
                                    <div class="county-stat-label">MAT Services</div>
                                </div>
                            </div>
                        `);
                    }

                    if (data.overdose_reduction) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Overdose Reduction</h4>
                            <div class="county-stat-grid">
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.overdose_reduction.reduction_percent}%</div>
                                    <div class="county-stat-label">ED Visit Reduction</div>
                                </div>
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: #999; font-size: 1.1rem;">${data.overdose_reduction.ed_visits_previous} → ${data.overdose_reduction.ed_visits_current}</div>
                                    <div class="county-stat-label">ED Visits Change</div>
                                </div>
                            </div>
                        `);
                    }

                    if (data.jail_services) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Jail Health Navigation</h4>
                            <div class="county-stat-grid">
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.jail_services.detainees_identified}</div>
                                    <div class="county-stat-label">Detainees Identified</div>
                                </div>
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.jail_services.treatment_referrals}</div>
                                    <div class="county-stat-label">Treatment Referrals</div>
                                </div>
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.jail_services.patients_returned_for_help}</div>
                                    <div class="county-stat-label">Returned for Help</div>
                                </div>
                            </div>
                        `);
                    }

                    if (data.employment_transportation) {
                        sections.push(`
                            <div class="strategy-list">
                                <div class="strategy-list-item">
                                    <span class="strategy-name">SEATS Transportation</span>
                                    <span class="strategy-amount">${data.employment_transportation} rides provided</span>
                                </div>
                            </div>
                        `);
                    }
                }

                // Columbus - detailed outcomes and demographics
                if (county === 'Columbus') {
                    if (data.demographics) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Demographics</h4>
                            <div class="county-stat-grid">
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.demographics.men}</div>
                                    <div class="county-stat-label">Men</div>
                                </div>
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${data.demographics.women}</div>
                                    <div class="county-stat-label">Women</div>
                                </div>
                            </div>
                        `);
                    }

                    if (data.substance_use_breakdown) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Primary Substance Use</h4>
                            <div class="strategy-list">
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Opioids</span>
                                    <span class="strategy-amount">${data.substance_use_breakdown.opioids}</span>
                                </div>
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Crack Cocaine</span>
                                    <span class="strategy-amount">${data.substance_use_breakdown.crack_cocaine}</span>
                                </div>
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Alcohol</span>
                                    <span class="strategy-amount">${data.substance_use_breakdown.alcohol}</span>
                                </div>
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Methamphetamine</span>
                                    <span class="strategy-amount">${data.substance_use_breakdown.methamphetamine}</span>
                                </div>
                            </div>
                        `);
                    }

                    if (data.outcomes) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Harm Reduction Outcomes</h4>
                            <div class="county-stat-grid">
                                <div class="county-stat" style="background: ${data.outcomes.ems_overdose_calls_change < 0 ? '#e8f5e9' : '#fff3e0'};">
                                    <div class="county-stat-number" style="color: ${data.outcomes.ems_overdose_calls_change < 0 ? '#388e3c' : '#f57c00'}; font-size: 1.4rem;">${Math.round(data.outcomes.ems_overdose_calls_change * 100)}%</div>
                                    <div class="county-stat-label">EMS Overdose Calls</div>
                                </div>
                                <div class="county-stat" style="background: ${data.outcomes.naloxone_admin_change < 0 ? '#e8f5e9' : '#fff3e0'};">
                                    <div class="county-stat-number" style="color: ${data.outcomes.naloxone_admin_change < 0 ? '#388e3c' : '#f57c00'}; font-size: 1.4rem;">${Math.round(data.outcomes.naloxone_admin_change * 100)}%</div>
                                    <div class="county-stat-label">Naloxone Admin</div>
                                </div>
                                <div class="county-stat" style="background: ${data.outcomes.ed_visits_change < 0 ? '#e8f5e9' : '#fff3e0'};">
                                    <div class="county-stat-number" style="color: ${data.outcomes.ed_visits_change < 0 ? '#388e3c' : '#f57c00'}; font-size: 1.4rem;">${Math.round(data.outcomes.ed_visits_change * 100)}%</div>
                                    <div class="county-stat-label">ED Visits</div>
                                </div>
                                <div class="county-stat" style="background: #e8f5e9;">
                                    <div class="county-stat-number" style="color: #388e3c; font-size: 1.1rem;">${data.outcomes.deaths_fy23} → ${data.outcomes.deaths_fy24}</div>
                                    <div class="county-stat-label">Deaths (FY23→FY24)</div>
                                </div>
                            </div>
                        `);
                    }

                    if (data.programs) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Program Reach</h4>
                            <div class="strategy-list">
                                ${data.programs.call_center ? `<div class="strategy-list-item">
                                    <span class="strategy-name">24/7 Crisis Line</span>
                                    <span class="strategy-amount">${data.programs.call_center.calls_taken} calls</span>
                                </div>` : ''}
                                ${data.programs.nas_training ? `<div class="strategy-list-item">
                                    <span class="strategy-name">NAS Training</span>
                                    <span class="strategy-amount">${data.programs.nas_training.participants} participants</span>
                                </div>` : ''}
                                ${data.programs.prescriber_training ? `<div class="strategy-list-item">
                                    <span class="strategy-name">Prescriber Training</span>
                                    <span class="strategy-amount">${data.programs.prescriber_training.sessions_completed}/${data.programs.prescriber_training.sessions_total} sessions</span>
                                </div>` : ''}
                                ${data.programs.school_prevention ? `<div class="strategy-list-item">
                                    <span class="strategy-name">School Prevention</span>
                                    <span class="strategy-amount">${data.programs.school_prevention.students_trained} students trained</span>
                                </div>` : ''}
                            </div>
                        `);
                    }
                }

                // Richmond & Bladen - high success rates
                if (county === 'Richmond' || county === 'Bladen') {
                    if (data.completion_rate || data.employment_rate) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Program Success Rates</h4>
                            <div class="county-stat-grid">
                                ${data.completion_rate ? `<div class="county-stat" style="background: #e8f5e9;">
                                    <div class="county-stat-number" style="color: #388e3c; font-size: 1.4rem;">${(data.completion_rate * 100)}%</div>
                                    <div class="county-stat-label">Completion</div>
                                </div>` : ''}
                                ${data.employment_rate ? `<div class="county-stat" style="background: #e8f5e9;">
                                    <div class="county-stat-number" style="color: #388e3c; font-size: 1.4rem;">${(data.employment_rate * 100)}%</div>
                                    <div class="county-stat-label">Employment</div>
                                </div>` : ''}
                                ${data.treatment_adherence_rate ? `<div class="county-stat" style="background: #e8f5e9;">
                                    <div class="county-stat-number" style="color: #388e3c; font-size: 1.4rem;">${(data.treatment_adherence_rate * 100)}%</div>
                                    <div class="county-stat-label">Treatment Adherence</div>
                                </div>` : ''}
                                ${data.after_care_transfer_rate ? `<div class="county-stat" style="background: #e8f5e9;">
                                    <div class="county-stat-number" style="color: #388e3c; font-size: 1.4rem;">${(data.after_care_transfer_rate * 100)}%</div>
                                    <div class="county-stat-label">Aftercare Transfer</div>
                                </div>` : ''}
                            </div>
                        `);
                    }

                    if (county === 'Bladen' && data.average_length_of_stay_days) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Treatment Duration</h4>
                            <div class="county-stat-grid">
                                <div class="county-stat">
                                    <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}; font-size: 1.4rem;">${Math.round(data.average_length_of_stay_days)}</div>
                                    <div class="county-stat-label">Avg Days in Treatment</div>
                                </div>
                                ${data.stay_range ? `<div class="county-stat">
                                    <div class="county-stat-number" style="color: #999; font-size: 1.1rem;">${data.stay_range.min_days} - ${data.stay_range.max_days}</div>
                                    <div class="county-stat-label">Stay Range (Days)</div>
                                </div>` : ''}
                            </div>
                        `);
                    }
                }

                // Scotland - collaborative approach
                if (county === 'Scotland') {
                    if (data.phase) {
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Current Phase</h4>
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                                <p style="color: #555; line-height: 1.6;">${data.phase}</p>
                            </div>
                        `);
                    }

                    if (data.programs?.opioid_collaborative) {
                        const collab = data.programs.opioid_collaborative;
                        sections.push(`
                            <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1rem; font-weight: 600;">Opioid Collaborative</h4>
                            <div class="strategy-list">
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Meeting Schedule</span>
                                    <span class="strategy-amount">${collab.frequency}</span>
                                </div>
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Partners</span>
                                    <span class="strategy-amount">${collab.partners.length} agencies</span>
                                </div>
                                <div class="strategy-list-item">
                                    <span class="strategy-name">Status</span>
                                    <span class="strategy-amount">${collab.longevity}</span>
                                </div>
                            </div>
                        `);
                    }
                }

                outcomesHtml += sections.join('');
                outcomesHtml += '</div>';
            });

            outcomesHtml += '</div>';
            outcomesContainer.innerHTML = outcomesHtml;
        }

        function extractCountyName(govtName) {
            if (!govtName) return null;
            for (const county of FOCUS_COUNTIES) {
                if (govtName.includes(county)) {
                    return county;
                }
            }
            return null;
        }

        function createSpendingByCountyChart(data) {
            const ctx = document.getElementById('spendingByCountyChart').getContext('2d');
            const sortedCounties = Object.keys(data).sort((a, b) => data[b] - data[a]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCounties,
                    datasets: [{
                        label: 'Total Spending',
                        data: sortedCounties.map(county => data[county]),
                        backgroundColor: sortedCounties.map(county => COUNTY_COLORS[county] + '80'),
                        borderColor: sortedCounties.map(county => COUNTY_COLORS[county]),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ' County';
                                },
                                label: function(context) {
                                    return 'Total Spending: $' + (context.parsed.y / 1000000).toFixed(2) + 'M';
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return '$' + (value / 1000000).toFixed(2) + 'M';
                            },
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            color: function(context) {
                                return COUNTY_COLORS[sortedCounties[context.dataIndex]];
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStrategyCategoryChart(data, categoryLookup) {
            const ctx = document.getElementById('strategyCategoryChart').getContext('2d');
            const sortedCategories = Object.keys(data).sort((a, b) => data[b] - data[a]);

            const total = sortedCategories.reduce((sum, cat) => sum + data[cat], 0);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCategories.map(cat => categoryLookup[cat] || `Category ${cat}`),
                    datasets: [{
                        data: sortedCategories.map(cat => data[cat]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return context.label + ': $' + (value / 1000000).toFixed(2) + 'M (' + percentage + '%)';
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });
        }

        function createStrategiesByCountyChart(data, strategyLookup) {
            const tabsContainer = document.getElementById('strategiesTabsContainer');
            const chartsContainer = document.getElementById('strategiesChartsContainer');

            const counties = FOCUS_COUNTIES.filter(c => data[c]);

            if (counties.length === 0) return;

            // Create tabs
            let tabsHtml = '<div class="narrative-tabs">';
            counties.forEach((county, index) => {
                tabsHtml += `
                    <button class="narrative-tab strategy-tab ${index === 0 ? 'active' : ''}"
                            style="background-color: ${index === 0 ? COUNTY_COLORS[county] : '#f8f9fa'};"
                            data-county="${county}">
                        ${county} County
                    </button>
                `;
            });
            tabsHtml += '</div>';
            tabsContainer.innerHTML = tabsHtml;

            // Create canvas for each county
            let chartsHtml = '';
            counties.forEach((county, index) => {
                chartsHtml += `
                    <canvas id="strategyChart-${county}"
                            class="strategy-chart-canvas"
                            style="display: ${index === 0 ? 'block' : 'none'}; position: absolute; left: 0; top: 0; width: 100%; height: 100%;">
                    </canvas>
                `;
            });
            chartsContainer.innerHTML = chartsHtml;

            // Create charts for each county
            const charts = {};
            counties.forEach(county => {
                const countyStrategies = data[county] || {};
                const sortedStrategies = Object.entries(countyStrategies)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const labels = sortedStrategies.map(([stratLetter, amount]) => {
                    const strategyObj = Object.values(strategyLookup).find(s => s.strat_exhibit_letter === stratLetter);
                    const strategyName = strategyObj?.strat_name || strategyObj?.strat_title || '';
                    return strategyName ? `${strategyName} (${stratLetter})` : `Strategy ${stratLetter}`;
                });

                const amounts = sortedStrategies.map(([stratLetter, amount]) => amount);

                const ctx = document.getElementById(`strategyChart-${county}`).getContext('2d');
                charts[county] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spending',
                            data: amounts,
                            backgroundColor: COUNTY_COLORS[county] + '80',
                            borderColor: COUNTY_COLORS[county],
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        return 'Spending: $' + context.parsed.x.toLocaleString();
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'right',
                                formatter: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                },
                                font: {
                                    weight: 'bold',
                                    size: 11
                                },
                                color: COUNTY_COLORS[county]
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                }
                            }
                        }
                    }
                });
            });

            // Add click handlers for tabs
            const tabs = tabsContainer.querySelectorAll('.strategy-tab');
            const canvases = chartsContainer.querySelectorAll('.strategy-chart-canvas');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const county = tab.dataset.county;

                    // Update tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.backgroundColor = '#f8f9fa';
                    });
                    tab.classList.add('active');
                    tab.style.backgroundColor = COUNTY_COLORS[county];

                    // Update canvas visibility
                    canvases.forEach(canvas => {
                        canvas.style.display = 'none';
                    });
                    document.getElementById(`strategyChart-${county}`).style.display = 'block';
                });
            });
        }

        function createCountyBreakdowns(spendingByCounty, strategiesByCounty, strategyLookup, categoryLookup, finDetailData, narrativeData) {
            const container = document.getElementById('countyBreakdownsContainer');

            FOCUS_COUNTIES.forEach(county => {
                if (!spendingByCounty[county]) return;

                const card = document.createElement('div');
                card.className = 'county-breakdown-card';
                card.style.borderTopColor = COUNTY_COLORS[county];

                const totalSpending = spendingByCounty[county];
                const countyStrategies = strategiesByCounty[county] || {};
                const strategyCount = Object.keys(countyStrategies).length;

                // Get narrative data for this county
                const countyNarrative = narrativeData?.counties?.[county] || null;
                if (countyNarrative) {
                    console.log(`✅ Found narrative data for ${county}:`, countyNarrative);
                }

                // Determine strategy options and planning status
                // ALL counties start with Option A (12 high-impact strategies)
                // Option B (80+ strategies) unlocked ONLY after completing strategic planning
                // Based on comprehensive analysis of spending patterns and narratives

                let optionStatus = {
                    label: 'High-Impact',
                    badge: 'Option A',
                    badgeColor: COUNTY_COLORS[county],
                    icon: '✓',
                    planningStatus: null,
                    availableStrategies: 12
                };

                const countyFinData = finDetailData.filter(row =>
                    row.govt_name && row.govt_name.includes(county) && row.fd_strat_funds_applied > 0
                );

                if (countyFinData.length > 0) {
                    // Get all strategy categories being funded
                    const categoriesUsed = new Set();
                    countyFinData.forEach(row => {
                        const strategy = strategyLookup[row.strat_id_num];
                        if (strategy && strategy.strat_cat_letter) {
                            categoriesUsed.add(strategy.strat_cat_letter);
                        }
                    });

                    // County-specific Option B status based on analysis
                    // Columbus is ONLY county currently using Option B strategies
                    if (county === 'Columbus') {
                        // Using 11 Option B-only strategies (categories B, E, F, G, H, J)
                        const optionBCategories = ['B', 'E', 'F', 'G', 'H', 'J'];
                        const usingOptionB = [...categoriesUsed].some(cat => optionBCategories.includes(cat));

                        if (usingOptionB) {
                            optionStatus = {
                                label: 'Expanded Access',
                                badge: 'Option A + B',
                                badgeColor: '#28a745',
                                icon: '✨',
                                planningStatus: 'Completed - ROSC Model (FY 2023-24)',
                                availableStrategies: '80+'
                            };
                        }
                    } else if (county === 'Robeson') {
                        optionStatus.badge = 'Option A';
                        optionStatus.badgeColor = '#ff9800';  // Orange for in-progress
                        optionStatus.icon = '🔄';
                        optionStatus.label = 'Preparing for Expansion';
                        optionStatus.planningStatus = 'Strategic planning with SPARC/RRCOR for FY25';
                    } else if (county === 'Bladen') {
                        optionStatus.badge = 'Option A';
                        optionStatus.badgeColor = '#ff9800';  // Orange for submitted
                        optionStatus.icon = '📋';
                        optionStatus.label = 'Expansion Plan Submitted';
                        optionStatus.planningStatus = 'Option B plan submitted 9/16/24, pending approval for FY25';
                    } else if (county === 'Cumberland') {
                        optionStatus.planningStatus = 'C-FORT Collaborative: 8 of 12 Option A strategies';
                    } else if (county === 'Richmond') {
                        optionStatus.planningStatus = 'DEFT Coordination: 3 strategies with 100% success rates';
                    } else if (county === 'Scotland') {
                        optionStatus.planningStatus = 'Capacity Building: Active Opioid Collaborative';
                    }
                }

                // Get top strategies
                const topStrategies = Object.entries(countyStrategies)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                let html = `
                    <div class="county-breakdown-header">
                        <div class="county-breakdown-name" style="color: ${COUNTY_COLORS[county]}">${county} County</div>
                        <div style="text-align: right;">
                            <span style="background: ${optionStatus.badgeColor}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; display: inline-block; margin-bottom: 5px;">
                                ${optionStatus.icon} ${optionStatus.badge}
                            </span>
                            ${optionStatus.planningStatus ? `<div style="font-size: 0.75rem; color: #666; margin-top: 5px;">${optionStatus.planningStatus}</div>` : ''}
                        </div>
                    </div>

                    <div class="county-stat-grid">
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">
                                $${totalSpending.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                            </div>
                            <div class="county-stat-label">Total Spending</div>
                        </div>
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${strategyCount}</div>
                            <div class="county-stat-label">Strategies Funded</div>
                        </div>
                `;

                // Add narrative metrics if available
                if (countyNarrative) {
                    if (countyNarrative.people_served) {
                        html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${countyNarrative.people_served.toLocaleString()}</div>
                            <div class="county-stat-label">People Served</div>
                        </div>
                        `;
                    }
                    if (countyNarrative.naloxone_kits) {
                        html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${countyNarrative.naloxone_kits.toLocaleString()}</div>
                            <div class="county-stat-label">Naloxone Kits Distributed</div>
                        </div>
                        `;
                    }
                    if (countyNarrative.treatment_days) {
                        html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${countyNarrative.treatment_days.toLocaleString()}</div>
                            <div class="county-stat-label">Treatment Days</div>
                        </div>
                        `;
                    }
                    // Add key outcome metrics
                    if (countyNarrative.outcomes) {
                        if (countyNarrative.outcomes.treatment_referrals) {
                            html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${countyNarrative.outcomes.treatment_referrals.toLocaleString()}</div>
                            <div class="county-stat-label">Treatment Referrals</div>
                        </div>
                            `;
                        }
                        if (countyNarrative.outcomes.total_contacts) {
                            html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${countyNarrative.outcomes.total_contacts.toLocaleString()}</div>
                            <div class="county-stat-label">Total Contacts</div>
                        </div>
                            `;
                        }
                    }
                    // Add treatment metrics for Robeson
                    if (countyNarrative.treatment) {
                        const totalTreatment = (countyNarrative.treatment.inpatient || 0) +
                                              (countyNarrative.treatment.outpatient || 0);
                        if (totalTreatment > 0) {
                            html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${totalTreatment}</div>
                            <div class="county-stat-label">Treatment Services</div>
                        </div>
                            `;
                        }
                    }
                    // Add overdose reduction for Robeson
                    if (countyNarrative.overdose_reduction && countyNarrative.overdose_reduction.reduction_percent) {
                        html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${countyNarrative.overdose_reduction.reduction_percent}%</div>
                            <div class="county-stat-label">ED Visit Reduction</div>
                        </div>
                        `;
                    }
                    // Add completion rate for Richmond and Bladen
                    if (countyNarrative.completion_rate) {
                        html += `
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${(countyNarrative.completion_rate * 100)}%</div>
                            <div class="county-stat-label">Completion Rate</div>
                        </div>
                        `;
                    }
                }

                html += `
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1.1rem;">Top Strategies:</h4>
                    <div class="strategy-list">
                `;

                topStrategies.forEach(([stratLetter, amount]) => {
                    // Find the full strategy name
                    const strategy = Object.values(strategyLookup).find(s => s.strat_exhibit_letter === stratLetter);
                    const strategyName = strategy?.strat_name || strategy?.strat_title || `Strategy ${stratLetter}`;

                    html += `
                        <div class="strategy-list-item">
                            <span class="strategy-name">${strategyName} (${stratLetter})</span>
                            <span class="strategy-amount">$${(amount / 1000).toFixed(1)}K</span>
                        </div>
                    `;
                });

                html += '</div>';

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function createNarrativesSection(impactSummary, impactDetail, strategyLookup) {
            const container = document.getElementById('narrativesContainer');

            // Group by county
            const countyData = {};

            impactSummary.forEach(row => {
                const county = extractCountyName(row.govt_name);
                if (county && !countyData[county]) {
                    countyData[county] = {
                        narrative: row.is_impact_narrative || '',
                        progress: []
                    };
                }
            });

            impactDetail.forEach(row => {
                const county = extractCountyName(row.govt_name);
                if (county && countyData[county] && row.id_strat_progress_full) {
                    const strategy = strategyLookup[row.strat_id_num] || {};
                    const strategyName = strategy.strat_name || strategy.strat_title || '';
                    const strategyLetter = strategy.strat_exhibit_letter || row.strat_id_num;
                    const displayName = strategyName ? `${strategyName} (${strategyLetter})` : `Strategy ${strategyLetter}`;

                    countyData[county].progress.push({
                        strategy: displayName,
                        progress: row.id_strat_progress_full
                    });
                }
            });

            // Filter counties that have data
            const countiesWithData = FOCUS_COUNTIES.filter(county => countyData[county]);

            if (countiesWithData.length === 0) return;

            // Create tabs
            let tabsHtml = '<div class="narrative-tabs">';
            countiesWithData.forEach((county, index) => {
                tabsHtml += `
                    <button class="narrative-tab ${index === 0 ? 'active' : ''}"
                            style="background-color: ${index === 0 ? COUNTY_COLORS[county] : '#f8f9fa'};"
                            data-county="${county}">
                        ${county} County
                    </button>
                `;
            });
            tabsHtml += '</div>';

            // Create content for each county
            let contentHtml = '';
            countiesWithData.forEach((county, index) => {
                contentHtml += `
                    <div class="narrative-content ${index === 0 ? 'active' : ''}" data-county="${county}">
                        <div class="narrative-card" style="border-left: 5px solid ${COUNTY_COLORS[county]};">
                            <h3 style="color: ${COUNTY_COLORS[county]};">${county} County</h3>
                `;

                if (countyData[county].narrative) {
                    contentHtml += `<div class="narrative-text">${countyData[county].narrative}</div>`;
                }

                if (countyData[county].progress.length > 0) {
                    contentHtml += '<h4 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">Strategy Progress:</h4>';
                    countyData[county].progress.forEach(item => {
                        contentHtml += `
                            <div class="progress-item">
                                <div class="progress-strategy">${item.strategy}</div>
                                <div class="progress-detail">${item.progress}</div>
                            </div>
                        `;
                    });
                }

                contentHtml += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = tabsHtml + contentHtml;

            // Add click handlers for tabs
            const tabs = container.querySelectorAll('.narrative-tab');
            const contents = container.querySelectorAll('.narrative-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const county = tab.dataset.county;

                    // Update tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.backgroundColor = '#f8f9fa';
                    });
                    tab.classList.add('active');
                    tab.style.backgroundColor = COUNTY_COLORS[county];

                    // Update content
                    contents.forEach(c => c.classList.remove('active'));
                    container.querySelector(`.narrative-content[data-county="${county}"]`).classList.add('active');
                });
            });
        }

        function createDetailTable(data, strategyLookup, categoryLookup) {
            const tbody = document.querySelector('#detailTable tbody');

            // Sort by county then amount
            const sortedData = data
                .filter(row => row.fd_strat_funds_applied > 0)
                .sort((a, b) => {
                    const countyA = extractCountyName(a.govt_name);
                    const countyB = extractCountyName(b.govt_name);
                    if (countyA !== countyB) {
                        return countyA.localeCompare(countyB);
                    }
                    return (b.fd_strat_funds_applied || 0) - (a.fd_strat_funds_applied || 0);
                });

            sortedData.slice(0, 50).forEach(row => {
                const tr = document.createElement('tr');
                const strategy = strategyLookup[row.strat_id_num] || {};
                const categoryName = categoryLookup[strategy.strat_cat_letter] || strategy.strat_cat_letter || 'N/A';

                const strategyName = strategy.strat_name || strategy.strat_title || '';
                const strategyLetter = strategy.strat_exhibit_letter || row.strat_id_num;
                const displayName = strategyName ? `${strategyName} (${strategyLetter})` : `Strategy ${strategyLetter}`;

                tr.innerHTML = `
                    <td>${extractCountyName(row.govt_name) || row.govt_name}</td>
                    <td>${displayName}</td>
                    <td>${categoryName}</td>
                    <td>$${(row.fd_strat_funds_applied || 0).toLocaleString()}</td>
                    <td>${row.fy_str || row.fy_int || 'N/A'}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
