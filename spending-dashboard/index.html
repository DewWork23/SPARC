<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARC Spending & Strategy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .counties-list {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small {
            height: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .narrative-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .narrative-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .narrative-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .progress-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .progress-strategy {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .progress-detail {
            color: #666;
            font-size: 0.95rem;
        }

        .county-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .county-breakdown-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 5px solid;
        }

        .county-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .county-breakdown-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .county-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .county-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .county-stat-number {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .county-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .strategy-list {
            margin-top: 15px;
        }

        .strategy-list-item {
            padding: 10px;
            background: #f8f9fa;
            margin: 6px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strategy-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .strategy-amount {
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPARC Spending & Strategy Dashboard</h1>
            <p>Opioid Settlement Spending Analysis</p>
        </div>

        <div class="counties-list">
            Focus Counties: Robeson, Cumberland, Scotland, Richmond, Bladen, Columbus
        </div>

        <div id="loading" class="loading">
            Loading data from Excel file...
        </div>

        <div id="error" style="display: none;" class="error"></div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <div class="chart-card">
                    <h2 class="chart-title">Total Spending by County</h2>
                    <div class="chart-container">
                        <canvas id="spendingByCountyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 class="chart-title">Spending by Strategy Category</h2>
                    <div class="chart-container">
                        <canvas id="strategyCategoryChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">Strategies Funded by County</h2>
                    <div class="chart-container">
                        <canvas id="strategiesByCountyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">County Spending Breakdowns</h2>
                    <div class="county-breakdown-grid" id="countyBreakdownsContainer"></div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">County Narratives & Strategy Progress</h2>
                    <div id="narrativesContainer"></div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">Detailed Spending Breakdown</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="detailTable">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th>Strategy</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Fiscal Year</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Focus counties
        const FOCUS_COUNTIES = ['Robeson', 'Cumberland', 'Scotland', 'Richmond', 'Bladen', 'Columbus'];

        // County color scheme (consistent with enhanced dashboard)
        const COUNTY_COLORS = {
            'Cumberland': '#e74c3c',
            'Robeson': '#3498db',
            'Richmond': '#e67e22',
            'Columbus': '#f39c12',
            'Bladen': '#9b59b6',
            'Scotland': '#27ae60'
        };

        // Load and process Excel file
        async function loadData() {
            try {
                const response = await fetch('CORE-NC Opioid Settlement Public Data Tables.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Read relevant sheets
                const govtsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['govts']);
                const strategiesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['strategies']);
                const categoriesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['categories']);
                const finDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['fin_detail']);
                const paymentsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['payments_detail']);
                const impactSummarySheet = XLSX.utils.sheet_to_json(workbook.Sheets['impact_summary']);
                const impactDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['impact_detail']);

                // Process data
                processData(govtsSheet, strategiesSheet, categoriesSheet, finDetailSheet, paymentsSheet, impactSummarySheet, impactDetailSheet);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'Error loading data: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function processData(govts, strategies, categories, finDetail, payments, impactSummary, impactDetail) {
            // Filter data for focus counties
            const focusCountyData = finDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create lookups
            const strategyLookup = {};
            strategies.forEach(strat => {
                strategyLookup[strat.strat_id_num] = strat;
            });

            const categoryLookup = {};
            categories.forEach(cat => {
                categoryLookup[cat.strat_cat_letter] = cat.strat_cat_name || cat.strat_cat_letter;
            });

            // Aggregate spending by county
            const spendingByCounty = {};
            const spendingByCategory = {};
            const strategiesByCounty = {};

            focusCountyData.forEach(row => {
                const county = extractCountyName(row.govt_name);
                const amount = parseFloat(row.fd_strat_funds_applied) || 0;
                const stratId = row.strat_id_num;
                const strategy = strategyLookup[stratId];

                if (county && amount > 0) {
                    // Spending by county
                    spendingByCounty[county] = (spendingByCounty[county] || 0) + amount;

                    // Spending by category
                    if (strategy && strategy.strat_cat_letter) {
                        const category = strategy.strat_cat_letter;
                        spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
                    }

                    // Strategies by county
                    if (!strategiesByCounty[county]) {
                        strategiesByCounty[county] = {};
                    }
                    if (strategy && strategy.strat_exhibit_letter) {
                        const stratName = `${strategy.strat_exhibit_letter}`;
                        strategiesByCounty[county][stratName] = (strategiesByCounty[county][stratName] || 0) + amount;
                    }
                }
            });

            // Filter impact data for focus counties
            const focusImpactSummary = impactSummary.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            const focusImpactDetail = impactDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create visualizations
            createSpendingByCountyChart(spendingByCounty);
            createStrategyCategoryChart(spendingByCategory, categoryLookup);
            createStrategiesByCountyChart(strategiesByCounty, strategyLookup);
            createCountyBreakdowns(spendingByCounty, strategiesByCounty, strategyLookup, categoryLookup, focusCountyData);
            createNarrativesSection(focusImpactSummary, focusImpactDetail, strategyLookup);
            createDetailTable(focusCountyData, strategyLookup, categoryLookup);

            // Hide loading, show dashboard
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function extractCountyName(govtName) {
            if (!govtName) return null;
            for (const county of FOCUS_COUNTIES) {
                if (govtName.includes(county)) {
                    return county;
                }
            }
            return null;
        }

        function createSpendingByCountyChart(data) {
            const ctx = document.getElementById('spendingByCountyChart').getContext('2d');
            const sortedCounties = Object.keys(data).sort((a, b) => data[b] - data[a]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCounties,
                    datasets: [{
                        label: 'Total Spending ($)',
                        data: sortedCounties.map(county => data[county]),
                        backgroundColor: sortedCounties.map(county => COUNTY_COLORS[county] + '80'),
                        borderColor: sortedCounties.map(county => COUNTY_COLORS[county]),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStrategyCategoryChart(data, categoryLookup) {
            const ctx = document.getElementById('strategyCategoryChart').getContext('2d');
            const sortedCategories = Object.keys(data).sort((a, b) => data[b] - data[a]);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCategories.map(cat => categoryLookup[cat] || `Category ${cat}`),
                    datasets: [{
                        data: sortedCategories.map(cat => data[cat]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStrategiesByCountyChart(data, strategyLookup) {
            const ctx = document.getElementById('strategiesByCountyChart').getContext('2d');

            // Get all unique strategies
            const allStrategies = new Set();
            Object.values(data).forEach(countyStrategies => {
                Object.keys(countyStrategies).forEach(strat => allStrategies.add(strat));
            });
            const strategies = Array.from(allStrategies).sort();

            const counties = FOCUS_COUNTIES.filter(c => data[c]);

            const datasets = strategies.slice(0, 10).map((strategy, index) => ({
                label: `Strategy ${strategy}`,
                data: counties.map(county => data[county][strategy] || 0),
                backgroundColor: `hsl(${index * 36}, 70%, 60%)`,
            }));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: counties,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCountyBreakdowns(spendingByCounty, strategiesByCounty, strategyLookup, categoryLookup, finDetailData) {
            const container = document.getElementById('countyBreakdownsContainer');

            FOCUS_COUNTIES.forEach(county => {
                if (!spendingByCounty[county]) return;

                const card = document.createElement('div');
                card.className = 'county-breakdown-card';
                card.style.borderTopColor = COUNTY_COLORS[county];

                const totalSpending = spendingByCounty[county];
                const countyStrategies = strategiesByCounty[county] || {};
                const strategyCount = Object.keys(countyStrategies).length;

                // Get top strategies
                const topStrategies = Object.entries(countyStrategies)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                let html = `
                    <div class="county-breakdown-header">
                        <div class="county-breakdown-name" style="color: ${COUNTY_COLORS[county]}">${county} County</div>
                    </div>

                    <div class="county-stat-grid">
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">$${(totalSpending / 1000000).toFixed(2)}M</div>
                            <div class="county-stat-label">Total Spending</div>
                        </div>
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${strategyCount}</div>
                            <div class="county-stat-label">Strategies Funded</div>
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1.1rem;">Top Strategies:</h4>
                    <div class="strategy-list">
                `;

                topStrategies.forEach(([stratLetter, amount]) => {
                    html += `
                        <div class="strategy-list-item">
                            <span class="strategy-name">Strategy ${stratLetter}</span>
                            <span class="strategy-amount">$${(amount / 1000).toFixed(1)}K</span>
                        </div>
                    `;
                });

                html += '</div>';

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function createNarrativesSection(impactSummary, impactDetail, strategyLookup) {
            const container = document.getElementById('narrativesContainer');

            // Group by county
            const countyData = {};

            impactSummary.forEach(row => {
                const county = extractCountyName(row.govt_name);
                if (county && !countyData[county]) {
                    countyData[county] = {
                        narrative: row.is_impact_narrative || '',
                        progress: []
                    };
                }
            });

            impactDetail.forEach(row => {
                const county = extractCountyName(row.govt_name);
                if (county && countyData[county] && row.id_strat_progress_full) {
                    const strategy = strategyLookup[row.strat_id_num] || {};
                    countyData[county].progress.push({
                        strategy: strategy.strat_exhibit_letter || row.strat_id_num,
                        progress: row.id_strat_progress_full
                    });
                }
            });

            // Display narratives for each county
            FOCUS_COUNTIES.forEach(county => {
                if (countyData[county]) {
                    const card = document.createElement('div');
                    card.className = 'narrative-card';

                    let html = `<h3>${county} County</h3>`;

                    if (countyData[county].narrative) {
                        html += `<div class="narrative-text">${countyData[county].narrative}</div>`;
                    }

                    if (countyData[county].progress.length > 0) {
                        html += '<h4 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">Strategy Progress:</h4>';
                        countyData[county].progress.forEach(item => {
                            html += `
                                <div class="progress-item">
                                    <div class="progress-strategy">Strategy ${item.strategy}</div>
                                    <div class="progress-detail">${item.progress}</div>
                                </div>
                            `;
                        });
                    }

                    card.innerHTML = html;
                    container.appendChild(card);
                }
            });
        }

        function createDetailTable(data, strategyLookup, categoryLookup) {
            const tbody = document.querySelector('#detailTable tbody');

            // Sort by county then amount
            const sortedData = data
                .filter(row => row.fd_strat_funds_applied > 0)
                .sort((a, b) => {
                    const countyA = extractCountyName(a.govt_name);
                    const countyB = extractCountyName(b.govt_name);
                    if (countyA !== countyB) {
                        return countyA.localeCompare(countyB);
                    }
                    return (b.fd_strat_funds_applied || 0) - (a.fd_strat_funds_applied || 0);
                });

            sortedData.slice(0, 50).forEach(row => {
                const tr = document.createElement('tr');
                const strategy = strategyLookup[row.strat_id_num] || {};
                const categoryName = categoryLookup[strategy.strat_cat_letter] || strategy.strat_cat_letter || 'N/A';

                tr.innerHTML = `
                    <td>${extractCountyName(row.govt_name) || row.govt_name}</td>
                    <td>Strategy ${strategy.strat_exhibit_letter || row.strat_id_num}</td>
                    <td>${categoryName}</td>
                    <td>$${(row.fd_strat_funds_applied || 0).toLocaleString()}</td>
                    <td>${row.fy_str || row.fy_int || 'N/A'}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
