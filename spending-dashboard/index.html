<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARC Spending & Strategy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .counties-list {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small {
            height: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPARC Spending & Strategy Dashboard</h1>
            <p>Opioid Settlement Spending Analysis</p>
        </div>

        <div class="counties-list">
            Focus Counties: Robeson, Cumberland, Scotland, Richmond, Bladen, Columbus
        </div>

        <div id="loading" class="loading">
            Loading data from Excel file...
        </div>

        <div id="error" style="display: none;" class="error"></div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <div class="chart-card">
                    <h2 class="chart-title">Total Spending by County</h2>
                    <div class="chart-container">
                        <canvas id="spendingByCountyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 class="chart-title">Spending by Strategy Category</h2>
                    <div class="chart-container">
                        <canvas id="strategyCategoryChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">Strategies Funded by County</h2>
                    <div class="chart-container">
                        <canvas id="strategiesByCountyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">Detailed Spending Breakdown</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="detailTable">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th>Strategy</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Fiscal Year</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Focus counties
        const FOCUS_COUNTIES = ['Robeson', 'Cumberland', 'Scotland', 'Richmond', 'Bladen', 'Columbus'];

        // Load and process Excel file
        async function loadData() {
            try {
                const response = await fetch('CORE-NC Opioid Settlement Public Data Tables.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Read relevant sheets
                const govtsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['govts']);
                const strategiesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['strategies']);
                const finDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['fin_detail']);
                const paymentsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['payments_detail']);

                // Process data
                processData(govtsSheet, strategiesSheet, finDetailSheet, paymentsSheet);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'Error loading data: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function processData(govts, strategies, finDetail, payments) {
            // Filter data for focus counties
            const focusCountyData = finDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create strategy lookup
            const strategyLookup = {};
            strategies.forEach(strat => {
                strategyLookup[strat.strat_id_num] = strat;
            });

            // Aggregate spending by county
            const spendingByCounty = {};
            const spendingByCategory = {};
            const strategiesByCounty = {};

            focusCountyData.forEach(row => {
                const county = extractCountyName(row.govt_name);
                const amount = parseFloat(row.fd_strat_funds_applied) || 0;
                const stratId = row.strat_id_num;
                const strategy = strategyLookup[stratId];

                if (county && amount > 0) {
                    // Spending by county
                    spendingByCounty[county] = (spendingByCounty[county] || 0) + amount;

                    // Spending by category
                    if (strategy && strategy.strat_cat_letter) {
                        const category = strategy.strat_cat_letter;
                        spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
                    }

                    // Strategies by county
                    if (!strategiesByCounty[county]) {
                        strategiesByCounty[county] = {};
                    }
                    if (strategy && strategy.strat_exhibit_letter) {
                        const stratName = `${strategy.strat_exhibit_letter}`;
                        strategiesByCounty[county][stratName] = (strategiesByCounty[county][stratName] || 0) + amount;
                    }
                }
            });

            // Create visualizations
            createSpendingByCountyChart(spendingByCounty);
            createStrategyCategoryChart(spendingByCategory);
            createStrategiesByCountyChart(strategiesByCounty, strategyLookup);
            createDetailTable(focusCountyData, strategyLookup);

            // Hide loading, show dashboard
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function extractCountyName(govtName) {
            if (!govtName) return null;
            for (const county of FOCUS_COUNTIES) {
                if (govtName.includes(county)) {
                    return county;
                }
            }
            return null;
        }

        function createSpendingByCountyChart(data) {
            const ctx = document.getElementById('spendingByCountyChart').getContext('2d');
            const sortedCounties = Object.keys(data).sort((a, b) => data[b] - data[a]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCounties,
                    datasets: [{
                        label: 'Total Spending ($)',
                        data: sortedCounties.map(county => data[county]),
                        backgroundColor: '#667eea',
                        borderColor: '#5568d3',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStrategyCategoryChart(data) {
            const ctx = document.getElementById('strategyCategoryChart').getContext('2d');
            const sortedCategories = Object.keys(data).sort((a, b) => data[b] - data[a]);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCategories.map(cat => `Category ${cat}`),
                    datasets: [{
                        data: sortedCategories.map(cat => data[cat]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStrategiesByCountyChart(data, strategyLookup) {
            const ctx = document.getElementById('strategiesByCountyChart').getContext('2d');

            // Get all unique strategies
            const allStrategies = new Set();
            Object.values(data).forEach(countyStrategies => {
                Object.keys(countyStrategies).forEach(strat => allStrategies.add(strat));
            });
            const strategies = Array.from(allStrategies).sort();

            const counties = Object.keys(data).sort();

            const datasets = strategies.slice(0, 10).map((strategy, index) => ({
                label: `Strategy ${strategy}`,
                data: counties.map(county => data[county][strategy] || 0),
                backgroundColor: `hsl(${index * 36}, 70%, 60%)`,
            }));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: counties,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDetailTable(data, strategyLookup) {
            const tbody = document.querySelector('#detailTable tbody');

            // Sort by county then amount
            const sortedData = data
                .filter(row => row.fd_strat_funds_applied > 0)
                .sort((a, b) => {
                    const countyA = extractCountyName(a.govt_name);
                    const countyB = extractCountyName(b.govt_name);
                    if (countyA !== countyB) {
                        return countyA.localeCompare(countyB);
                    }
                    return (b.fd_strat_funds_applied || 0) - (a.fd_strat_funds_applied || 0);
                });

            sortedData.slice(0, 50).forEach(row => {
                const tr = document.createElement('tr');
                const strategy = strategyLookup[row.strat_id_num] || {};

                tr.innerHTML = `
                    <td>${extractCountyName(row.govt_name) || row.govt_name}</td>
                    <td>Strategy ${strategy.strat_exhibit_letter || row.strat_id_num}</td>
                    <td>Category ${strategy.strat_cat_letter || 'N/A'}</td>
                    <td>$${(row.fd_strat_funds_applied || 0).toLocaleString()}</td>
                    <td>${row.fy_str || row.fy_int || 'N/A'}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
