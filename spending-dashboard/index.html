<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARC Spending & Strategy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .counties-list {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small {
            height: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .narrative-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .narrative-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .narrative-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .progress-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .progress-strategy {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .progress-detail {
            color: #666;
            font-size: 0.95rem;
        }

        .county-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .county-breakdown-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 5px solid;
        }

        .county-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .county-breakdown-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .county-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .county-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .county-stat-number {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .county-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .strategy-list {
            margin-top: 15px;
        }

        .strategy-list-item {
            padding: 10px;
            background: #f8f9fa;
            margin: 6px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strategy-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .strategy-amount {
            font-weight: bold;
            color: #667eea;
        }

        .narrative-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .narrative-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .narrative-tab:hover {
            background: #e8e9ea;
        }

        .narrative-tab.active {
            color: white;
            border-color: transparent;
        }

        .narrative-content {
            display: none;
        }

        .narrative-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPARC Spending & Strategy Dashboard</h1>
            <p>Opioid Settlement Spending Analysis</p>
        </div>

        <div class="counties-list">
            Focus Counties: Robeson, Cumberland, Scotland, Richmond, Bladen, Columbus
        </div>

        <div id="loading" class="loading">
            Loading data from Excel file...
        </div>

        <div id="error" style="display: none;" class="error"></div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-grid">
                <div class="chart-card">
                    <h2 class="chart-title">Total Spending by County</h2>
                    <div class="chart-container">
                        <canvas id="spendingByCountyChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h2 class="chart-title">Spending by Strategy Category</h2>
                    <div class="chart-container">
                        <canvas id="strategyCategoryChart"></canvas>
                    </div>
                </div>

                <!-- Strategies Funded by County - Commented out for now, can be restored later
                <div class="chart-card full-width">
                    <h2 class="chart-title">Strategies Funded by County</h2>
                    <div id="strategiesTabsContainer"></div>
                    <div id="strategiesChartsContainer" style="position: relative; height: 400px;"></div>
                </div>
                -->

                <div class="chart-card full-width">
                    <h2 class="chart-title">County Spending Breakdowns</h2>
                    <div class="county-breakdown-grid" id="countyBreakdownsContainer"></div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">County Narratives & Strategy Progress</h2>
                    <div id="narrativesContainer"></div>
                </div>

                <div class="chart-card full-width">
                    <h2 class="chart-title">Detailed Spending Breakdown</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="detailTable">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th>Strategy</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Fiscal Year</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Focus counties
        const FOCUS_COUNTIES = ['Robeson', 'Cumberland', 'Scotland', 'Richmond', 'Bladen', 'Columbus'];

        // County color scheme (consistent with enhanced dashboard)
        const COUNTY_COLORS = {
            'Cumberland': '#e74c3c',
            'Robeson': '#3498db',
            'Richmond': '#e67e22',
            'Columbus': '#f39c12',
            'Bladen': '#9b59b6',
            'Scotland': '#27ae60'
        };

        // Load and process Excel file
        async function loadData() {
            try {
                const response = await fetch('CORE-NC Opioid Settlement Public Data Tables.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Read relevant sheets
                const govtsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['govts']);
                const strategiesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['strategies']);
                const categoriesSheet = XLSX.utils.sheet_to_json(workbook.Sheets['categories']);
                const finDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['fin_detail']);
                const paymentsSheet = XLSX.utils.sheet_to_json(workbook.Sheets['payments_detail']);
                const impactSummarySheet = XLSX.utils.sheet_to_json(workbook.Sheets['impact_summary']);
                const impactDetailSheet = XLSX.utils.sheet_to_json(workbook.Sheets['impact_detail']);

                // Process data
                processData(govtsSheet, strategiesSheet, categoriesSheet, finDetailSheet, paymentsSheet, impactSummarySheet, impactDetailSheet);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'Error loading data: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function processData(govts, strategies, categories, finDetail, payments, impactSummary, impactDetail) {
            // Filter data for focus counties
            const focusCountyData = finDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create government lookup for option detection
            const govtLookup = {};
            govts.forEach(govt => {
                const county = extractCountyName(govt.govt_name);
                if (county && FOCUS_COUNTIES.includes(county)) {
                    // Look for option field - try multiple possible field names
                    const option = govt.option || govt.govt_option || govt.settlement_option || govt.opioid_option;
                    govtLookup[county] = {
                        ...govt,
                        detectedOption: option
                    };
                }
            });

            console.log('Government lookup with options:', govtLookup);

            // Create lookups
            const strategyLookup = {};
            strategies.forEach(strat => {
                strategyLookup[strat.strat_id_num] = strat;
            });

            const categoryLookup = {};
            categories.forEach(cat => {
                // Try multiple possible field names for category name
                const catName = cat.strat_cat_name || cat.strat_category_name || cat.category_name || cat.name;
                categoryLookup[cat.strat_cat_letter] = catName || cat.strat_cat_letter;
            });

            // Add fallback descriptions if not in data
            if (!categoryLookup['L'] || categoryLookup['L'] === 'L') {
                categoryLookup['L'] = 'Core Strategies';
            }
            if (!categoryLookup['C'] || categoryLookup['C'] === 'C') {
                categoryLookup['C'] = 'Collaborative Strategic Planning';
            }
            if (!categoryLookup['H'] || categoryLookup['H'] === 'H') {
                categoryLookup['H'] = 'Other Abatement Strategies';
            }

            // Aggregate spending by county
            const spendingByCounty = {};
            const spendingByCategory = {};
            const strategiesByCounty = {};

            focusCountyData.forEach(row => {
                const county = extractCountyName(row.govt_name);
                const amount = parseFloat(row.fd_strat_funds_applied) || 0;
                const stratId = row.strat_id_num;
                const strategy = strategyLookup[stratId];

                if (county && amount > 0) {
                    // Spending by county
                    spendingByCounty[county] = (spendingByCounty[county] || 0) + amount;

                    // Spending by category
                    if (strategy && strategy.strat_cat_letter) {
                        const category = strategy.strat_cat_letter;
                        spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
                    }

                    // Strategies by county
                    if (!strategiesByCounty[county]) {
                        strategiesByCounty[county] = {};
                    }
                    if (strategy && strategy.strat_exhibit_letter) {
                        const stratName = `${strategy.strat_exhibit_letter}`;
                        strategiesByCounty[county][stratName] = (strategiesByCounty[county][stratName] || 0) + amount;
                    }
                }
            });

            // Filter impact data for focus counties
            const focusImpactSummary = impactSummary.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            const focusImpactDetail = impactDetail.filter(row => {
                const govtName = row.govt_name || '';
                return FOCUS_COUNTIES.some(county => govtName.includes(county));
            });

            // Create visualizations
            createSpendingByCountyChart(spendingByCounty);
            createStrategyCategoryChart(spendingByCategory, categoryLookup);
            // createStrategiesByCountyChart(strategiesByCounty, strategyLookup); // Commented out for now
            createCountyBreakdowns(spendingByCounty, strategiesByCounty, strategyLookup, categoryLookup, focusCountyData, govtLookup);
            createNarrativesSection(focusImpactSummary, focusImpactDetail, strategyLookup);
            createDetailTable(focusCountyData, strategyLookup, categoryLookup);

            // Hide loading, show dashboard
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function extractCountyName(govtName) {
            if (!govtName) return null;
            for (const county of FOCUS_COUNTIES) {
                if (govtName.includes(county)) {
                    return county;
                }
            }
            return null;
        }

        function createSpendingByCountyChart(data) {
            const ctx = document.getElementById('spendingByCountyChart').getContext('2d');
            const sortedCounties = Object.keys(data).sort((a, b) => data[b] - data[a]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCounties,
                    datasets: [{
                        label: 'Total Spending',
                        data: sortedCounties.map(county => data[county]),
                        backgroundColor: sortedCounties.map(county => COUNTY_COLORS[county] + '80'),
                        borderColor: sortedCounties.map(county => COUNTY_COLORS[county]),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ' County';
                                },
                                label: function(context) {
                                    return 'Total Spending: $' + (context.parsed.y / 1000000).toFixed(2) + 'M';
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return '$' + (value / 1000000).toFixed(2) + 'M';
                            },
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            color: function(context) {
                                return COUNTY_COLORS[sortedCounties[context.dataIndex]];
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStrategyCategoryChart(data, categoryLookup) {
            const ctx = document.getElementById('strategyCategoryChart').getContext('2d');
            const sortedCategories = Object.keys(data).sort((a, b) => data[b] - data[a]);

            const total = sortedCategories.reduce((sum, cat) => sum + data[cat], 0);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCategories.map(cat => categoryLookup[cat] || `Category ${cat}`),
                    datasets: [{
                        data: sortedCategories.map(cat => data[cat]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return context.label + ': $' + (value / 1000000).toFixed(2) + 'M (' + percentage + '%)';
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });
        }

        function createStrategiesByCountyChart(data, strategyLookup) {
            const tabsContainer = document.getElementById('strategiesTabsContainer');
            const chartsContainer = document.getElementById('strategiesChartsContainer');

            const counties = FOCUS_COUNTIES.filter(c => data[c]);

            if (counties.length === 0) return;

            // Create tabs
            let tabsHtml = '<div class="narrative-tabs">';
            counties.forEach((county, index) => {
                tabsHtml += `
                    <button class="narrative-tab strategy-tab ${index === 0 ? 'active' : ''}"
                            style="background-color: ${index === 0 ? COUNTY_COLORS[county] : '#f8f9fa'};"
                            data-county="${county}">
                        ${county} County
                    </button>
                `;
            });
            tabsHtml += '</div>';
            tabsContainer.innerHTML = tabsHtml;

            // Create canvas for each county
            let chartsHtml = '';
            counties.forEach((county, index) => {
                chartsHtml += `
                    <canvas id="strategyChart-${county}"
                            class="strategy-chart-canvas"
                            style="display: ${index === 0 ? 'block' : 'none'}; position: absolute; left: 0; top: 0; width: 100%; height: 100%;">
                    </canvas>
                `;
            });
            chartsContainer.innerHTML = chartsHtml;

            // Create charts for each county
            const charts = {};
            counties.forEach(county => {
                const countyStrategies = data[county] || {};
                const sortedStrategies = Object.entries(countyStrategies)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const labels = sortedStrategies.map(([stratLetter, amount]) => {
                    const strategyObj = Object.values(strategyLookup).find(s => s.strat_exhibit_letter === stratLetter);
                    const strategyName = strategyObj?.strat_name || strategyObj?.strat_title || '';
                    return strategyName ? `${strategyName} (${stratLetter})` : `Strategy ${stratLetter}`;
                });

                const amounts = sortedStrategies.map(([stratLetter, amount]) => amount);

                const ctx = document.getElementById(`strategyChart-${county}`).getContext('2d');
                charts[county] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spending',
                            data: amounts,
                            backgroundColor: COUNTY_COLORS[county] + '80',
                            borderColor: COUNTY_COLORS[county],
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        return 'Spending: $' + context.parsed.x.toLocaleString();
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'right',
                                formatter: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                },
                                font: {
                                    weight: 'bold',
                                    size: 11
                                },
                                color: COUNTY_COLORS[county]
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                }
                            }
                        }
                    }
                });
            });

            // Add click handlers for tabs
            const tabs = tabsContainer.querySelectorAll('.strategy-tab');
            const canvases = chartsContainer.querySelectorAll('.strategy-chart-canvas');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const county = tab.dataset.county;

                    // Update tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.backgroundColor = '#f8f9fa';
                    });
                    tab.classList.add('active');
                    tab.style.backgroundColor = COUNTY_COLORS[county];

                    // Update canvas visibility
                    canvases.forEach(canvas => {
                        canvas.style.display = 'none';
                    });
                    document.getElementById(`strategyChart-${county}`).style.display = 'block';
                });
            });
        }

        function createCountyBreakdowns(spendingByCounty, strategiesByCounty, strategyLookup, categoryLookup, finDetailData, govtLookup) {
            const container = document.getElementById('countyBreakdownsContainer');

            FOCUS_COUNTIES.forEach(county => {
                if (!spendingByCounty[county]) return;

                const card = document.createElement('div');
                card.className = 'county-breakdown-card';
                card.style.borderTopColor = COUNTY_COLORS[county];

                const totalSpending = spendingByCounty[county];
                const countyStrategies = strategiesByCounty[county] || {};
                const strategyCount = Object.keys(countyStrategies).length;

                // Determine option from govtLookup data or infer from spending
                let option = 'Unknown';
                if (govtLookup[county] && govtLookup[county].detectedOption) {
                    option = govtLookup[county].detectedOption;
                } else {
                    // Infer from spending patterns
                    const hasCollaborativePlanning = Object.entries(countyStrategies).some(([letter, amount]) => {
                        const strat = Object.values(strategyLookup).find(s => s.strat_exhibit_letter === letter);
                        return strat && strat.strat_cat_letter === 'C' && amount > 0;
                    });
                    if (hasCollaborativePlanning) {
                        option = 'Option B';
                    } else if (strategyCount > 0) {
                        option = 'Option A';
                    }
                }

                // Get top strategies
                const topStrategies = Object.entries(countyStrategies)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                let html = `
                    <div class="county-breakdown-header">
                        <div class="county-breakdown-name" style="color: ${COUNTY_COLORS[county]}">${county} County</div>
                        <span style="background: ${COUNTY_COLORS[county]}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">${option}</span>
                    </div>

                    <div class="county-stat-grid">
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">
                                $${totalSpending.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                            </div>
                            <div class="county-stat-label">Total Spending</div>
                        </div>
                        <div class="county-stat">
                            <div class="county-stat-number" style="color: ${COUNTY_COLORS[county]}">${strategyCount}</div>
                            <div class="county-stat-label">Strategies Funded</div>
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #2c3e50; font-size: 1.1rem;">Top Strategies:</h4>
                    <div class="strategy-list">
                `;

                topStrategies.forEach(([stratLetter, amount]) => {
                    // Find the full strategy name
                    const strategy = Object.values(strategyLookup).find(s => s.strat_exhibit_letter === stratLetter);
                    const strategyName = strategy?.strat_name || strategy?.strat_title || `Strategy ${stratLetter}`;

                    html += `
                        <div class="strategy-list-item">
                            <span class="strategy-name">${strategyName} (${stratLetter})</span>
                            <span class="strategy-amount">$${(amount / 1000).toFixed(1)}K</span>
                        </div>
                    `;
                });

                html += '</div>';

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function createNarrativesSection(impactSummary, impactDetail, strategyLookup) {
            const container = document.getElementById('narrativesContainer');

            // Group by county
            const countyData = {};

            impactSummary.forEach(row => {
                const county = extractCountyName(row.govt_name);
                if (county && !countyData[county]) {
                    countyData[county] = {
                        narrative: row.is_impact_narrative || '',
                        progress: []
                    };
                }
            });

            impactDetail.forEach(row => {
                const county = extractCountyName(row.govt_name);
                if (county && countyData[county] && row.id_strat_progress_full) {
                    const strategy = strategyLookup[row.strat_id_num] || {};
                    const strategyName = strategy.strat_name || strategy.strat_title || '';
                    const strategyLetter = strategy.strat_exhibit_letter || row.strat_id_num;
                    const displayName = strategyName ? `${strategyName} (${strategyLetter})` : `Strategy ${strategyLetter}`;

                    countyData[county].progress.push({
                        strategy: displayName,
                        progress: row.id_strat_progress_full
                    });
                }
            });

            // Filter counties that have data
            const countiesWithData = FOCUS_COUNTIES.filter(county => countyData[county]);

            if (countiesWithData.length === 0) return;

            // Create tabs
            let tabsHtml = '<div class="narrative-tabs">';
            countiesWithData.forEach((county, index) => {
                tabsHtml += `
                    <button class="narrative-tab ${index === 0 ? 'active' : ''}"
                            style="background-color: ${index === 0 ? COUNTY_COLORS[county] : '#f8f9fa'};"
                            data-county="${county}">
                        ${county} County
                    </button>
                `;
            });
            tabsHtml += '</div>';

            // Create content for each county
            let contentHtml = '';
            countiesWithData.forEach((county, index) => {
                contentHtml += `
                    <div class="narrative-content ${index === 0 ? 'active' : ''}" data-county="${county}">
                        <div class="narrative-card" style="border-left: 5px solid ${COUNTY_COLORS[county]};">
                            <h3 style="color: ${COUNTY_COLORS[county]};">${county} County</h3>
                `;

                if (countyData[county].narrative) {
                    contentHtml += `<div class="narrative-text">${countyData[county].narrative}</div>`;
                }

                if (countyData[county].progress.length > 0) {
                    contentHtml += '<h4 style="margin-top: 15px; margin-bottom: 10px; color: #2c3e50;">Strategy Progress:</h4>';
                    countyData[county].progress.forEach(item => {
                        contentHtml += `
                            <div class="progress-item">
                                <div class="progress-strategy">${item.strategy}</div>
                                <div class="progress-detail">${item.progress}</div>
                            </div>
                        `;
                    });
                }

                contentHtml += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = tabsHtml + contentHtml;

            // Add click handlers for tabs
            const tabs = container.querySelectorAll('.narrative-tab');
            const contents = container.querySelectorAll('.narrative-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const county = tab.dataset.county;

                    // Update tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.backgroundColor = '#f8f9fa';
                    });
                    tab.classList.add('active');
                    tab.style.backgroundColor = COUNTY_COLORS[county];

                    // Update content
                    contents.forEach(c => c.classList.remove('active'));
                    container.querySelector(`.narrative-content[data-county="${county}"]`).classList.add('active');
                });
            });
        }

        function createDetailTable(data, strategyLookup, categoryLookup) {
            const tbody = document.querySelector('#detailTable tbody');

            // Sort by county then amount
            const sortedData = data
                .filter(row => row.fd_strat_funds_applied > 0)
                .sort((a, b) => {
                    const countyA = extractCountyName(a.govt_name);
                    const countyB = extractCountyName(b.govt_name);
                    if (countyA !== countyB) {
                        return countyA.localeCompare(countyB);
                    }
                    return (b.fd_strat_funds_applied || 0) - (a.fd_strat_funds_applied || 0);
                });

            sortedData.slice(0, 50).forEach(row => {
                const tr = document.createElement('tr');
                const strategy = strategyLookup[row.strat_id_num] || {};
                const categoryName = categoryLookup[strategy.strat_cat_letter] || strategy.strat_cat_letter || 'N/A';

                const strategyName = strategy.strat_name || strategy.strat_title || '';
                const strategyLetter = strategy.strat_exhibit_letter || row.strat_id_num;
                const displayName = strategyName ? `${strategyName} (${strategyLetter})` : `Strategy ${strategyLetter}`;

                tr.innerHTML = `
                    <td>${extractCountyName(row.govt_name) || row.govt_name}</td>
                    <td>${displayName}</td>
                    <td>${categoryName}</td>
                    <td>$${(row.fd_strat_funds_applied || 0).toLocaleString()}</td>
                    <td>${row.fy_str || row.fy_int || 'N/A'}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
